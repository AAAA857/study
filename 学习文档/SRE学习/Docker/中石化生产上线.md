# 中石化生产上线

|                           修复问题                           |                           处理动作                           |                           镜像版本                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|                      cskb 同步 unit数据                      | 1.参考“沃尔沃UAT-TQA组件更新20240202”文档<br/>2.需要kafka 开启外部访问端口，天牛更新一下即可 | backend:20240312_1710243157927<br/>    ngd-fe:20240308——1709869929354 |
|                       cskb spring漏洞                        |       1.删除cskb-backend 空间下 apollo 3条ingress规则        |             kubectl get ingress -n cskb-backend              |
| UNIT-运营工具-数据统计-知识数据 点击7天、9天、30天报错系统异常 |                       更新backend镜像                        |                backend:20240312_1710243157927                |
|                tableqa表格模版撤回知识还命中                 |                       更新adpater镜像                        |            unit-private-realtime-adapter:1.0.59.4            |
| UNIT 运营工具-标注数据-用户问法，用户进行分词检索，查询不到期望结果 |                   更新镜像core,backend,fe                    | backend:20240312_1710243157927<br/>    ngd-fe:20240308——1709869929354<br/>    core:20240311_1710160774697 |
|          中石化UNIT - NLU测试结果跟测试框结果不一致          |                   更新镜像core,backend,fe                    | backend:20240312_1710243157927<br/>    ngd-fe:20240308——1709869929354<br/>    core:20240311_1710160774697 |
|                       CSKB .et文件支持                       |                更新apollo配置并将cskb pod重启                |                                                              |
|       运营标注工具-标注数据-用户用法，查询不到期望结果       |                   更新镜像core,backend,fe                    | backend:20240312_1710243157927<br/>    ngd-fe:20240308——1709869929354<br/>    core:20240311_1710160774697 |
|                                                              |                                                              |                                                              |

## cskb 同步 unit数据:

```shell
# kafka开启外部访问端口
  1. external 如果没开启在天牛更新一下kafka chart 将开关打开即可
  
# 服务镜像
  同步测试环境backend与ngd-fe镜像即可

	backend:20240312_1710243157927
    ngd-fe:20240308——1709869929354
    
# 更新sql
  需要看一下生产环境 backend_offline是否有CSKB_SYNC表有就不需要初始化执行
  
# 天牛新增全局变量
  参考下面表格新增
# backend-offline chart configmap新增配置
    cskb.sync.enable={{ .Values.cskb.sync.enable }} # 是否开启消费cskb 知识消息，如果要关闭，天⽜变量
则设置为false即可。
    cskb.open.url={{ .Values.cskb.sync.openUrl }} # cskb open服务地址
    cskb.storage.url={{ .Values.cskb.sync.storageUrl }} # cskb storage服务地址
    cskb.sync.groupId={{ .Values.cskb.sync.groupId }} # unit程序消费cskb知识消息的groupid
    cskb.sync.topic={{ .Values.cskb.sync.kafkaTopic }} # cskb知识消息的kafka topic
    cskb.sync.kafka.data.metadata.broker.list={{ .Values.cskb.sync.kafkaBrokerList }} # cskb环境的
    kafka 地址
    cskb.sync.cskb.image.prefix=/cskb/storage/v1/download
    cskb.sync.unit.image.prefix=/ngd/api/v2/file/download
```

**天牛新增全局变量**

| 名称                    | 值                         | 描述                                                         |
| ----------------------- | -------------------------- | ------------------------------------------------------------ |
| cskbSyncTopic           | NGDV711                    | CSKB kafka用来同步数据的topic名称，不需要手动创建            |
| cskbSyncTaskCron        | 0 0/1 * * * ?              | 不需要添加，添加backend启动失败                              |
| cskbSyncStorageUrl      | http://10.188.102.155:8563 | 同步cskb知识。cskb-server-storage 服务地址， 石化走客户的ELB需要配置ELB地址 |
| cskbSyncOpenUrl         | http://10.188.102.155:8573 | 私有化可能修改的配置-CSKB知识同步 ，石化走客户的ELB需要配置ELB地址 |
| cskbSyncKafkaBrokerList | 10.188.102.155:8296        | 配置cskb kafka对外访问端口，需要kafka开启external配置        |
| cskbSyncGroupId         | CSKB_SYNC_UNIT_GROUP_707   | cskb知识同步 kafka group 默认值即可                          |
| cskbSyncEnable          | true                       | 是否开启CSKB 的同步功能                                      |

## cskb spring漏洞:

```shell
 删除cskb-backend名称空间下apollo ingress 规则
 
 $ kubectl get ingress -n cskb-backend
 $ kubectl delete ingress -n cskb-backend <apollo-ingrees-name>
 
 
# 测试
  1. 浏览器直接访问cskb域名如下接口:
     https://域名/config
     https://域名/admin
  3. 返回404表示正常
```

## UNIT-运营工具-数据统计-知识数据 点击7天、9天、30天报错系统异常:

```shell
  天牛平台更新backend-offline 和 backend-online 镜像即可
   backend:20240312_1710243157927
   
 # 测试
   UNIT-运营工具-数据统计-知识数据 点击7天、9天、30天 点击无报错即可
```

## tableqa表格模版撤回知识还命中:

```shell
   天牛同步更新unit-private-realtime-adapter镜像即可
   unit-private-realtime-adapter:1.0.59.4

# 测试
  1. 可以手动创建模板然后做验证 或者找QA验证即可
```

## UNIT 运营工具-标注数据-用户问法，用户进行分词检索，查询不到期望结果:

```shell
# 服务镜像
  天牛同步测试环境backend与ngd-fe镜像即可

	backend:20240312_1710243157927
    ngd-fe:20240308——1709869929354
    core:20240311_1710160774697
# 验证
  1. QA验证
```

## 中石化UNIT - NLU测试结果跟测试框结果不一致:

```shell
# 服务镜像
  天牛同步测试环境backend与ngd-fe镜像即可

	backend:20240312_1710243157927
    ngd-fe:20240308——1709869929354
    core:20240311_1710160774697
# 验证
  1. QA验证
```

## 运营标注工具-标注数据-用户用法，查询不到期望结果：

```shell
# 服务镜像
  天牛同步测试环境backend与ngd-fe镜像即可
	backend:20240312_1710243157927
    ngd-fe:20240308——1709869929354
    core:20240311_1710160774697
# 验证
  1. QA验证
```

## CSKB .et文件支持:

```shell
#appollo 增加
   app.audit.doc.import.formats：doc,docx,xls,xlsx,pdf,html,ppt,pptx,txt,et
# 重启 
  cskb-server-gateway, cskb-server-task-center, cskb-server-core，cskb-server-audit, cskb-server-document 
```

